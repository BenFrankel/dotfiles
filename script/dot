#!/usr/bin/env bash

set -eu
# set -x

usage() {
    printf 'Usage: dot <command> [arguments]

Description: Dotfile manager; run `dot install` to get started.

Available commands:

    get               Install latest config
    push [message]    Push config to repo
    restore           Restore backed up config
    pack-save         Save installed packages
'
    exit 1
}

[ $# -ge 1  ] || usage
[ $# -eq 1 -o "$1" == "push" ] || usage


DOT_DIR="${HOME}/.dotfiles"
CONFIG_DIR="${DOT_DIR}/config"
SCRIPT_DIR="${DOT_DIR}/script"
BACKUP_DIR="${DOT_DIR}/backup"
PACK_DIR="${DOT_DIR}/pack"


progress() {
    echo "$(tput bold)$1$(tput sgr0)..."
}


pack-load() {
    [ $# -eq 1 ] && ext="$1" || ext=''
    cat "${PACK_DIR}/pacman${ext}"
    cat "${PACK_DIR}/aur${ext}"
}

pack-save() {
    [ $# -eq 1 ] && ext="$1" || ext=''
    pacman -Qqen | sort > "${PACK_DIR}/pacman${ext}"
    pacman -Qqem | sort > "${PACK_DIR}/aur${ext}"
}

pack-install() {
    progress "Backing up installed packages"
    pack-save ".old"

    progress "Refreshing pacman database"
    sudo pacman -Sy

    progress "Removing installed packages that are unlisted"
    unlisted="$(comm -13 "${PACK_DIR}/pacman" "${PACK_DIR}/pacman.old")"
    unlisted+="$(comm -13 "${PACK_DIR}/aur" "${PACK_DIR}/aur.old")"
    [ -n "${unlisted}" ] && sudo pacman -Rns $unlisted

    progress "Installing listed packages that are not installed"
    listed="$(comm -23 "${PACK_DIR}/pacman" "${PACK_DIR}/pacman.old")"
    [ -n "${listed}" ] && sudo pacman -S $listed
    listed="$(comm -23 "${PACK_DIR}/aur" "${PACK_DIR}/aur.old")"
    [ -n "${listed}" ] && yaourt -S $listed
    
    return 0
}

get-repo() {
    progress "Getting latest repository"
    if [ ! -d "${DOT_DIR}/.git" ]; then
        git clone https://github.com/BenFrankel/dotfiles "${DOT_DIR}"
        mkdir -p "${BACKUP_DIR}" "${PACK_DIR}"
    else
        cd "${DOT_DIR}"
        git pull origin master
    fi
}

push() {
    progress "Pushing to repository"
    cd "${DOT_DIR}"
    git add .
    git commit -m "$1"
    git push origin master
}

setup() {
    progress "Setting up links to dotfiles"
    for path in $(find "${CONFIG_DIR}" -maxdepth 1 -type f); do
        filename=$(basename "${path}")
        if [ -f "${HOME}/.${filename}" -a ! -h "${HOME}/.${filename}" ]; then
            cp "${HOME}/.${filename}" "${BACKUP_DIR}/${filename}"
        fi
        ln -sf "${path}" "${HOME}/.${filename}"
    done

    progress "Setting up links to scripts"
    mkdir -p "${HOME}/bin"
    for path in $(find "${SCRIPT_DIR}" -maxdepth 1 -type f); do
        filename=$(basename "${path}")
        ln -sf "${path}" "${HOME}/bin/{filename}"
    done

    progress "Setting up package configurations"
    for package in $(find "${CONFIG_DIR}" -mindepth 1 -maxdepth 1 -type d); do
        eval "${package}/setup"
    done
}


case $1 in
    get)
        get-repo
        echo
        setup
        echo
        pack-install
        ;;
    push)
        pack-save
        push "${@:2}"
        ;;
    restore)
        progress "Restoring backups"
        
        progress "Removing installed packages"
        ;;
    pack-save)
        pack-save
        ;;
    *)
        usage
        ;;
esac

exit 0
